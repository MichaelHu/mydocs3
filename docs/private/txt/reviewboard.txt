# ########################################
## RedHat Linux: Review Board Installation
## Michael Hu
## 2011-04-10
# ########################################

Review Board

http://www.reviewboard.org/docs/manual/dev/admin/installation/linux/

手动安装的参考资料：
http://igormilovanovic.com/blog/2008/01/install-reviewboard-on-centos-5-1/

Dependencies:

Python v2.4+
MySQL v5.0.31+
PostgreSQL
sqlite v3

Apache + mod_python or fastcgi
lighhtpd + fastcgi

Using a HTTP Proxy

Installing Python Setuptools
python-setuptools


Installing Python Development Headers
python-devel


Installing memcached

Installing patch

Installing Review Board

Installing Database Bindings

Installing Source Control Components

Installing Amazon S3 Support (optional)

Installing PyLucene (optional)

Installing Development Tools (optional)

Creating Sites



配置proxy：
export http_proxy=http://tc-apptest-img06.vm.baidu.com:8066

1. 安装python 2.5.2
wget "http://www.python.org/ftp/python/2.5.2/Python-2.5.2.tar.bz2"

tar xvjf Python-2.5.2.tar.bz2
cd Python-2.5.2
mkdir -p /home/work/softwares/python
./configure --prefix=/home/work/softwares/python \
    --enable-shared

需要修改.bashrc，以确保使用新版本的python

确认版本：
python -V


2. 安装MySQL5.1
wget "http://ftp.gwdg.de/pub/misc/mysql/Downloads/MySQL-5.1/mysql-5.1.56.tar.gz"
tar zxvf mysql-5.1.56.tar.gz
cd mysql-5.1.56
mkdir -p /home/work/softwares/reviewboard/mysql
./configure --prefix=/home/img/softwares/reviewboard/mysql \
    --with-charset=utf8 \
    --with-unix-socket-path=/tmp/reviewboard_mysql.sock \
    --with-tcp-port=3340

make > log_make.log 2>&1
make install > log_make_install.log 2>&1

mkdir -p /home/work/softwares/reviewboard/mysql/var

./mysql_install_db \
    --datadir=/home/work/softwares/reviewboard/mysql/var/

    Installing MySQL system tables...
    OK
    Filling help tables...
    OK

    To start mysqld at boot time you have to copy
    support-files/mysql.server to the right place for your system

    PLEASE REMEMBER TO SET A PASSWORD FOR THE MySQL root USER !
    To do so, start the server, then issue the following commands:

    /home/work/softwares/reviewboard/mysql/bin/mysqladmin -u root password 'new-password'
    /home/work/softwares/reviewboard/mysql/bin/mysqladmin -u root -h localhost.localdomain password 'new-password'

    Alternatively you can run:
    /home/work/softwares/reviewboard/mysql/bin/mysql_secure_installation

    which will also give you the option of removing the test
    databases and anonymous user created by default.  This is
    strongly recommended for production servers.

    See the manual for more instructions.

    You can start the MySQL daemon with:
    cd /home/work/softwares/reviewboard/mysql ; /home/work/softwares/reviewboard/mysql/bin/mysqld_safe &

    You can test the MySQL daemon with mysql-test-run.pl
    cd /home/work/softwares/reviewboard/mysql/mysql-test ; perl mysql-test-run.pl

    Please report any problems with the /home/work/softwares/reviewboard/mysql/bin/mysqlbug script!

./mysqld_safe \
    --defaults-file=/home/img/softwares/reviewboard/mysql/share/mysql/my-medium.cnf \
    --socket=/tmp/reviewboard_mysql.sock \
    --port=3330 \
    --datadir=/home/img/softwares/reviewboard/mysql/var/ &

2.1 安装MySQL-python

##########################################
说明：
安装之前，需要先确保easy_install已经安装。见4
##########################################

tar zxvf MySQL-python-1.2.3.tar.gz
cd MySQL-python-1.2.3
# edit site.cfg if necessary，配置mysql_config的路径
python setup.py build
# 最后一步需要root权限，如果python是安装在系统目录的话
sudo python setup.py install # or su first

    安装的时候，可能出现以下问题：
    [work@localhost MySQL-python-1.2.3]$ python setup.py build
    sh: line 1: mysql_config: command not found
    Traceback (most recent call last):
      File "setup.py", line 15, in <module>
        metadata, options = get_config()
      File "/home/work/repos_softwares/mysql_softwares/MySQL-python-1.2.3/setup_posix.py", line 43, in get_config
        libs = mysql_config("libs_r")
      File "/home/work/repos_softwares/mysql_softwares/MySQL-python-1.2.3/setup_posix.py", line 24, in mysql_config
        raise EnvironmentError("%s not found" % (mysql_config.path,))
    EnvironmentError: mysql_config not found

    原因是mysql没有安装在默认目录，在/usr/local/bin找不到mysql_config，可以修改site.cfg文件，添加
    mysql_config = /home/work/softwares/reviewboard/mysql/bin/mysql_config


安装以后，用tests文件夹下面的程序文件测试可用性。
可能出现libmysqlclient_r.so.16文件找不到的问题，原因是MySQL没有安装在标准目录，
而build的时候也不知如何指定特定lib目录，需要做一个符号链接：

cd /home/work/softwares/reviewboard/mysql/lib/mysql
ln -s /home/work/softwares/reviewboard/mysql/lib/mysql/libmysqlclient_r.so.16 libmysqlclient_r.so.16

基本测试通过！尚需注意一个问题：
Traceback (most recent call last):
  File "/home/work/repos_softwares/mysql/MySQL-python-1.2.3/tests/capabilities.py", line 143, in test_truncation
    self.create_table(columndefs)
  File "/home/work/repos_softwares/mysql/MySQL-python-1.2.3/tests/capabilities.py", line 77, in create_table
    self.create_table_extra))
  File "build/bdist.linux-x86_64/egg/MySQLdb/cursors.py", line 176, in execute
    if not self._defer_warnings: self._warning_check()
  File "build/bdist.linux-x86_64/egg/MySQLdb/cursors.py", line 92, in _warning_check
    warn(w[-1], self.Warning, 3)
  File "/home/work/softwares/python/lib/python2.5/warnings.py", line 62, in warn
    globals)
  File "/home/work/softwares/python/lib/python2.5/warnings.py", line 102, in warn_explicit
    raise message
Warning: Unknown table engine 'INNODB'



3. Django Python框架
wget "http://media.djangoproject.com/releases/1.3/Django-1.3.tar.gz"
tar xzvf Django-1.3.tar.gz
cd Django-1.3
sudo python setup.py install

自动安装在python的lib目录下。
需要用root权限安装，如果python安装在系统目录下的话。
#### 注意，1.6.1需要Django-1.3.1及以上版本


4. 安装easy_install和setuptools
[work@tc-news-lvi0.tc.baidu.com ReviewBoard-1.6beta1]$ python ez_setup.py 
Downloading http://pypi.python.org/packages/2.5/s/setuptools/setuptools-0.6c11-py2.5.egg
Processing setuptools-0.6c11-py2.5.egg
Copying setuptools-0.6c11-py2.5.egg to /home/work/softwares/python/lib/python2.5/site-packages
Adding setuptools 0.6c11 to easy-install.pth file
Installing easy_install script to /home/work/softwares/python/bin
Installing easy_install-2.5 script to /home/work/softwares/python/bin

Installed /home/work/softwares/python/lib/python2.5/site-packages/setuptools-0.6c11-py2.5.egg
Processing dependencies for setuptools==0.6c11
Finished processing dependencies for setuptools==0.6c11

##########################################
说明：
easy_install和setuptools需要在安装MySQL-python之前安装，而安装easy_install的时候，
需要将egg文件放入python安装路径下，需要确保有足够的权限。如果python是安装在系统路径下，
那么easy_install的安装需要root权限。

[root@localhost ReviewBoard-1.6rc1]# python ez_setup.py 
Downloading http://pypi.python.org/packages/2.5/s/setuptools/setuptools-0.6c11-py2.5.egg
Processing setuptools-0.6c11-py2.5.egg
Copying setuptools-0.6c11-py2.5.egg to /usr/local/lib/python2.5/site-packages
Adding setuptools 0.6c11 to easy-install.pth file
Installing easy_install script to /usr/local/bin
Installing easy_install-2.5 script to /usr/local/bin

Installed /usr/local/lib/python2.5/site-packages/setuptools-0.6c11-py2.5.egg
Processing dependencies for setuptools==0.6c11
Finished processing dependencies for setuptools==0.6c11

否则，会出现以下错误：

[work@localhost ReviewBoard-1.6rc1]$ python ez_setup.py 
Downloading http://pypi.python.org/packages/2.5/s/setuptools/setuptools-0.6c11-py2.5.egg
error: can't create or remove files in install directory

The following error occurred while trying to add or remove files in the
installation directory:

    [Errno 13] Permission denied: '/usr/local/lib/python2.5/site-packages/test-easy-install-5508.write-test'

The installation directory you specified (via --install-dir, --prefix, or
the distutils default setting) was:

    /usr/local/lib/python2.5/site-packages/

Perhaps your account does not have write access to this directory?  If the
installation directory is a system-owned directory, you may need to sign in
as the administrator or "root" account.  If you do not have administrative
access to this machine, you may wish to choose a different installation
directory, preferably one that is listed in your PYTHONPATH environment
variable.

For information on other options, you may wish to consult the
documentation at:

  http://peak.telecommunity.com/EasyInstall.html

Please make the appropriate changes for your system and try again.
##########################################



5. 安装Apache2，带mod_python

mkdir -p /home/work/softwares/reviewboard/apache

tar zxvf httpd-2.2.13.tar.gz
cd httpd-2.2.13
# 比较特殊，目标机器的libexpat.so.1文件在/usr/lib而不是在/lib64中，
# 我们也无root权限，无法做符号链接，导致无法正常启动httpd。所以在这里特别指定
./configure LDFLAGS="-L/usr/lib" \
    --prefix=/home/work/softwares/reviewboard/apache \
    --enable-so \
    --enable-deflate

(make && make install) > log_install.log 2>&1

5.1 安装mod_python

wget "http://archive.apache.org/dist/httpd/modpython/mod_python-3.3.1.tgz"
tar zxvf mod_python-3.3.1.tgz
cd mod_python-3.3.1

./configure --with-apxs=/home/work/softwares/reviewboard/apache/bin/apxs \
    --with-python=/home/work/softwares/python/bin/python

make
make install

############################################
说明：
如果python安装在系统目录下，比如/usr/bin/python，那么第三步install需要root权限。
############################################

问题解决：
make过程中一直报错：
connobject.lo connobject.c && touch connobject.slo connobject.c: In function ‘_conn_read’: 
connobject.c:142: error: request for member ‘next’ in something not a structure or union
参考这篇文章：http://kunzhu.co.cc/wordpress/posts/mod-python.html
【
将源码中的connobject.c文件中的
!(b == APR_BRIGADE_SENTINEL(b) ||
改成!(b == APR_BRIGADE_SENTINEL(bb) ||
】
重新make，通过！！

修改apache的httpd.conf，添加
LoadModule python_module modules/mod_python.so

<Directory "/home/work/pythonapp">
    Allow from all
    #设定.prog扩展名的文件时使用mod_python处理PythonHandler test
    #AddHandler mod_python .prog

    #设定使用任意文件名时使用mod_python处理PythonHandler test
    SetHandler mod_python

    #调用PythonHandler test
    PythonHandler test

    #开启mod_python的Debug模式
    PythonDebug On

    #禁止浏览器从映射的目录/py/中下载py和pyc为扩展名的文件
    <FilesMatch "\.(py|pyc)">
        Order allow,deny
        Deny from all
    </FilesMatch>
</Directory>

Alias /py "/home/work/pythonapp"

再编写test.py文件放入/home/work/pythonapp目录，完成后，访问http://host/py



6. 安装pysvn

http://pysvn.tigris.org/project_downloads.html

依赖：
To build pysvn you will require:

    * Python 2.2 or later with these options:
          o Python runtime package
          o Python development package
          o Python pyexpat package 
    * subversion 1.5.x or 1.6.x with these options:
          o Subversion client package
          o Subversion development package 
    * PyCXX V6.2.2 to build against Python 2 or Python 3 which is included in the pysvn source kit.

Some distributions will split python and subversion into more the one package.

You will need to find all the packages that give you the options listed above.

6.1 安装pycxx

关于pycxx：
    PyCXX is designed to make it easier to extend Python with C++

    CXX/Objects is a set of C++ facilities to make it easier to write Python extensions. The chief way in which PyCXX makes it easier to write Python extensions is that it greatly increases the probability that your program will not make a reference-counting error and will not have to continually check error returns from the Python C API. CXX/Objects integrates Python with C++ in these ways:

    C++ exception handling is relied on to detect errors and clean up. In a complicated function this is often a tremendous problem when writing in C. With PyCXX, we let the compiler keep track of what objects need to be dereferenced when an error occurs.
    The Standard Template Library (STL) and its many algorithms plug and play with Python containers such as lists and tuples.
    The optional CXX/Extensions facility allows you to replace the clumsy C tables with objects and method calls that define your modules and extension objects.

安装文档查看README.html
tar zxvf pycxx-6.2.3.tar.gz
cd pycxx-6.2.3
python setup.py build
python setup.py install

测试是否安装成功：


6.2 

[work@tc-news-lvi0.tc.baidu.com pysvn-1.7.5]$ python setup.py build
running build
running build_ext
building '_pysvn' extension
creating build
creating build/lib.linux-x86_64-2.5
gcc -pthread -shared -L/home/work/softwares/python/lib -lpython2.5 -o build/lib.linux-x86_64-2.5/_pysvn.so


[work@tc-news-lvi0.tc.baidu.com pysvn-1.7.5]$ python setup.py install
...
Error: These sources are not compatible with python 2.5 - run the backport command to fix
...

问题解决参考：http://pysvn.tigris.org/ds/viewMessage.do?dsForumId=1335&dsMessageId=2692393

cd Source
python setup.py backport

python setup.py configure --apr-inc-dir=/home/img/softwares/svn/svn_dependency/apr-1.4.2/include/apr-1/ \
        --apr-lib-dir=/home/img/softwares/svn/svn_dependency/apr-1.4.2/lib \
        --pycxx-src-dir=/home/img/repos_softwares/softwares/python_softwares/pycxx-6.2.3/Src \

# 若SVN是单独安装，以下选项可以添加上去
        --svn-bin-dir=/home/work/svn/subversion-1.6.11/bin \
        --svn-inc-dir=/home/work/svn/subversion-1.6.11/include/subversion-1 \
        --svn-lib-dir=/home/work/svn/subversion-1.6.11/lib
#        --svn-root-dir=<dir>
#        --pycxx-dir=<dir> \

make
    ...
    pysvn_svnenv.hpp:27:23: apr_xlate.h: No such file or directory
    make: *** [pysvn.o] Error 1
    ...

将aprutil的include和lib文件分别合并至apr下面，再重新进行configure 和 make

    ...
    /usr/bin/ld: cannot find -lcom_err
    collect2: ld returned 1 exit status
    make: *** [pysvn/_pysvn_2_5.so] Error 1

缺少libcom_err.so，libssl.so等，都从其他机器拷过来，放到svn的lib下面，再行make

这次总算通过。
[work@tc-news-lvi0.tc.baidu.com Source]$ make
Compile pysvn/_pysvn_2_5.so
g++ -shared  -o pysvn/_pysvn_2_5.so pysvn.o pysvn_callbacks.o pysvn_client.o pysvn_static_strings.o \
    pysvn_enum_string.o pysvn_client_cmd_add.o pysvn_client_cmd_changelist.o pysvn_client_cmd_checkin.o \
    pysvn_client_cmd_copy.o pysvn_client_cmd_diff.o pysvn_client_cmd_export.o pysvn_client_cmd_info.o \
    pysvn_client_cmd_list.o pysvn_client_cmd_lock.o pysvn_client_cmd_merge.o pysvn_client_cmd_prop.o \
    pysvn_client_cmd_revprop.o pysvn_client_cmd_switch.o pysvn_transaction.o pysvn_revision.o pysvn_docs.o \
    pysvn_path.o pysvn_arg_processing.o pysvn_converters.o pysvn_svnenv.o pysvn_profile.o cxxsupport.o \
    cxx_extensions.o cxxextensions.o IndirectPythonInterface.o \
    -L/home/work/svn/subversion-1.6.11/lib -Wl,--rpath -Wl,/home/work/svn/subversion-1.6.11/lib -lsvn_client-1 \
    -lsvn_diff-1 -lsvn_repos-1 -lcom_err -lresolv -lexpat -lssl

再运行安装程序：
cd ..
python setup.py build
python setup.py install

good!!




cd /home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard
python test.py

    提示 nose module未定义
    安装python-nose

    python-nose python单元测试
    http://somethingaboutorange.com/mrl/projects/nose/1.0.0/

    wget "http://somethingaboutorange.com/mrl/projects/nose/nose-1.0.0.tar.gz"
    tar zxvf nose-1.0.0.tar.gz
    cd nose-1.0.0
    python setup.py install

    ...
    Processing nose-1.0.0-py2.5.egg
    creating /home/work/softwares/python/lib/python2.5/site-packages/nose-1.0.0-py2.5.egg
    Extracting nose-1.0.0-py2.5.egg to /home/work/softwares/python/lib/python2.5/site-packages
    Adding nose 1.0.0 to easy-install.pth file
    Installing nosetests script to /home/work/softwares/python/bin
    Installing nosetests-2.5 script to /home/work/softwares/python/bin

    Installed /home/work/softwares/python/lib/python2.5/site-packages/nose-1.0.0-py2.5.egg
    Processing dependencies for nose==1.0.0
    Finished processing dependencies for nose==1.0.0

    完成安装python-nose


python test.py
    
    Traceback (most recent call last):
      File "test.py", line 45, in <module>
        from django.db import connection
      File "/home/work/softwares/python/lib/python2.5/site-packages/django/db/__init__.py", line 14, in <module>
        if not settings.DATABASES:
      File "/home/work/softwares/python/lib/python2.5/site-packages/django/utils/functional.py", line 276, in __getattr__
        self._setup()
      File "/home/work/softwares/python/lib/python2.5/site-packages/django/conf/__init__.py", line 40, in _setup
        raise ImportError("Settings cannot be imported, because environment variable %s is undefined." % ENVIRONMENT_VARIABLE)
    ImportError: Settings cannot be imported, because environment variable DJANGO_SETTINGS_MODULE is undefined.

    解决方案：添加环境变量，如下：

export DJANGO_SETTINGS_MODULE=reviewboard.settings
export PYTHONPATH=/home/img/softwares/python/lib/python2.5/site-packages/setuptools-0.6c11-py2.5.egg\
:/home/img/softwares/python/lib/python2.5/site-packages/MySQL_python-1.2.3-py2.5-linux-x86_64.egg\
:/home/img/softwares/python/lib/python2.5/site-packages/pysvn-1.7.5-py2.5-linux-x86_64.egg\
:/home/img/softwares/python/lib/python2.5/site-packages/nose-1.0.0-py2.5.egg\
:/home/img/softwares/python/lib/python25.zip\
:/home/img/softwares/python/lib/python2.5\
:/home/img/softwares/python/lib/python2.5/plat-linux2\
:/home/img/softwares/python/lib/python2.5/lib-tk\
:/home/img/softwares/python/lib/python2.5/lib-dynload\
:/home/img/softwares/python/lib/python2.5/site-packages\
:/home/img/repos_softwares/softwares/review-board/ReviewBoard-1.6.1\
:/home/img/repos_softwares/softwares/review-board/ReviewBoard-1.6.1/reviewboard

python test.py

    [work@tc-news-lvi0.tc.baidu.com reviewboard]$ python test.py 
    Traceback (most recent call last):
      File "test.py", line 47, in <module>
        from djblets.util.misc import generate_media_serial
    ImportError: No module named djblets.util.misc

    解决方案：
    安装Djblets 0.5.6
    http://pypi.python.org/pypi/Djblets/0.5.6
    export http_proxy=http://tc-apptest-img06.vm.baidu.com:8066
    wget "http://downloads.reviewboard.org/releases/Djblets/0.5/Djblets-0.5.9.tar.gz"
    tar zxvf Djblets-0.5.9.tar.gz
    cd Djblets-0.5.9
    # 可能会自动下载依赖：Downloading http://downloads.reviewboard.org/mirror/PIL-1.1.6.tar.gz
    python setup.py install

    可能版本太低
    ...
    File "/home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard/accounts/models.py", line 9, in <module>
        from djblets.util.fields import CounterField
    ImportError: cannot import name CounterField

    安装个新的，0.6.7
    http://downloads.reviewboard.org/releases/Djblets/0.6/
    export http_proxy=http://tc-apptest-img06.vm.baidu.com:8066
    wget "http://downloads.reviewboard.org/releases/Djblets/0.6/Djblets-0.6.7.tar.gz"
    tar zxvf Djblets-0.6.7.tar.gz
    cd Djblets-0.6.7
    python setup.py install

    # 安装过程中，需要连接HTTP服务器


python test.py

不再报错。



# 再进一步test

python manage.py test
    Error: No module named django_evolution
    解决方案：
    wget "http://pypi.python.org/packages/source/d/django_evolution/django_evolution-0.5.tar.gz#md5=603cd8dc3ac13963c1b3d5b18e7e3615"
    tar zxvf django_evolution-0.5.tar.gz
    cd django_evolution-0.5
    python setup.py install
    搞定

    但可能存在版本过低的问题，需要更新成0.6.*版本
    http://pypi.python.org/pypi/django_evolution/0.6.2
    wget "http://pypi.python.org/packages/source/d/django_evolution/django_evolution-0.6.2.tar.gz#md5=8cc00d8247e8a612deaa355044b59939"
    tar zxvf django_evolution-0.6.2.tar.gz
    cd django_evolution-0.6.2




python manage.py test
    ...
      File "/home/work/softwares/python/lib/python2.5/site-packages/MySQL_python-1.2.3-py2.5-linux-x86_64.egg/MySQLdb/connections.py", line 187, in __init__
    _mysql_exceptions.OperationalError: (1045, "Access denied for user 'work'@'localhost' (using password: NO)")    

    解决方案：
    修改/home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard/settings_local.py
    修改其中数据库连接部分的配置，数据库NAME改成reviewboard，USER改成root

python manage.py test
    ...
    File "/home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard/accounts/models.py", line 9, in <module>
        from djblets.util.fields import CounterField
    ImportError: cannot import name CounterField

    解决方案：更新djblets的版本。


python manage.py test
    ...
    File "/home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard/accounts/forms.py", line 11, in <module>
        from recaptcha.client import captcha
    ImportError: No module named recaptcha.client

    解决方案：安装recaptcha-client
    http://pypi.python.org/pypi/recaptcha-client
    wget "http://pypi.python.org/packages/source/r/recaptcha-client/recaptcha-client-1.0.5.tar.gz#md5=f810750fb0be4e1d08b2253e22cbc5d7"
    tar zxvf recaptcha-client-1.0.5.tar.gz
    cd recaptcha-client-1.0.5
    python setup.py install



python manage.py test
    ...
    File "/home/work/softwares/python/lib/python2.5/site-packages/django_evolution-0.5-py2.5.egg/django_evolution/db/__init__.py", line 8, in <module>
        evolver = module.EvolutionOperations()
    AttributeError: 'module' object has no attribute 'EvolutionOperations'

    解决方案：django_evolution版本过低
    按照以上django_evolution安装方法，安装新版本django_evolution。


python manage.py test
    ...
    File "/home/work/softwares/python/lib/python2.5/site-packages/nose-1.0.0-py2.5.egg/nose/config.py", line 391, in configureWhere
        "not a directory" % path)
    ValueError: Working directory reviewboard not found, or not a directory

    解决方案：
    新增工作目录，
    mkdir -p /home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard/reviewboard

    #### 注意，以上解决方案不可行，可行解决方案是改变运行目录，确保运行目录下有reviewboard目录，如下
cd /home/img/repos_softwares/softwares/review-board/ReviewBoard-1.6rc1/
python reviewboard/manage.py test > test.log 2>&1


python manage.py test
    [work@tc-news-lvi0.tc.baidu.com reviewboard]$ python manage.py test
    /home/work/softwares/python/lib/python2.5/site-packages/django/core/management/commands/test.py:32: DeprecationWarning: Function-based test runners are deprecated. Test runners should be classes with a run_tests() method.
      DeprecationWarning
    Creating test database for alias 'default'...
    Got an error creating the test database: (1007, "Can't create database 'test_'; database exists")
    Type 'yes' if you would like to try deleting the test database 'test_', or 'no' to cancel: yes
    Destroying old test database 'default'...
    Creating tables ...
    Installing custom SQL ...
    Installing indexes ...
    No fixtures found.

    ----------------------------------------------------------------------
    Ran 0 tests in 0.000s

    OK

总算通过。但需要注意：No fixtures found.

#### 注意： 第一次安装，以上说法是不对的，根本没有运行测试用例。最好将test日志打印出来，然后分析test.log，根据里面的错误提示，将缺失的部分补上。




开始同步数据库：

python manage.py syncdb

    Creating tables ...
    Creating table django_admin_log
    Creating table auth_permission
    Creating table auth_group_permissions
    Creating table auth_group
    Creating table auth_user_user_permissions
    Creating table auth_user_groups
    Creating table auth_user
    Creating table auth_message
    Creating table django_content_type
    Creating table django_site
    Creating table django_session
    Creating table siteconfig_siteconfiguration
    Creating table accounts_reviewrequestvisit
    Creating table accounts_profile_starred_review_requests
    Creating table accounts_profile_starred_groups
    Creating table accounts_profile
    Creating table accounts_localsiteprofile
    Creating table changedescs_changedescription
    Creating table diffviewer_filediff
    Creating table diffviewer_diffset
    Creating table diffviewer_diffsethistory
    Creating table reviews_group_users
    Creating table reviews_group
    Creating table reviews_defaultreviewer_repository
    Creating table reviews_defaultreviewer_people
    Creating table reviews_defaultreviewer_groups
    Creating table reviews_defaultreviewer
    Creating table reviews_screenshot
    Creating table reviews_reviewrequest_changedescs
    Creating table reviews_reviewrequest_target_people
    Creating table reviews_reviewrequest_inactive_screenshots
    Creating table reviews_reviewrequest_screenshots
    Creating table reviews_reviewrequest_target_groups
    Creating table reviews_reviewrequest
    Creating table reviews_reviewrequestdraft_target_people
    Creating table reviews_reviewrequestdraft_inactive_screenshots
    Creating table reviews_reviewrequestdraft_screenshots
    Creating table reviews_reviewrequestdraft_target_groups
    Creating table reviews_reviewrequestdraft
    Creating table reviews_comment
    Creating table reviews_screenshotcomment
    Creating table reviews_review_comments
    Creating table reviews_review_screenshot_comments
    Creating table reviews_review
    Creating table scmtools_tool
    Creating table scmtools_repository_review_groups
    Creating table scmtools_repository_users
    Creating table scmtools_repository
    Creating table site_localsite_users
    Creating table site_localsite_admins
    Creating table site_localsite
    Creating table django_project_version
    Creating table django_evolution
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Installing baseline version
    Evolutions in sessions baseline: session_expire_date_db_index
    Evolutions in diffviewer baseline: add_parent_diffs, filediff_filenames_1024_chars, diffset_basedir, filediff_status
    Evolutions in reviews baseline: change_descriptions, last_review_timestamp, shipit_count, default_reviewer_repositories, null_repository, localsite, group_incoming_request_count, group_invite_only, group_visible, default_reviewer_local_site
    Evolutions in scmtools baseline: bugzilla_url_charfield, repository_raw_file_url, repository_visible, repository_path_length_255, localsite, repository_access_control, group_site

    You just installed Django's auth system, which means you don't have any superusers defined.
    Would you like to create one now? (yes/no): yes
    Username (Leave blank to use 'work'):                  
    E-mail address: hudamin@baidu.com
    Password:reviewboard
    Superuser created successfully.
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Unable to load SCMTool svn = reviewboard.scmtools.svn:SVNTool: pytz
    Unable to load SCMTool git = reviewboard.scmtools.git:GitTool: pytz
    Unable to load SCMTool bzr = reviewboard.scmtools.bzr:BZRTool: pytz
    Unable to load SCMTool cvs = reviewboard.scmtools.cvs:CVSTool: pytz
    Unable to load SCMTool perforce = reviewboard.scmtools.perforce:PerforceTool: pytz
    Unable to load SCMTool plastic = reviewboard.scmtools.plastic:PlasticTool: pytz
    Unable to load SCMTool clearcase = reviewboard.scmtools.clearcase:ClearCaseTool: pytz
    Unable to load SCMTool hg = reviewboard.scmtools.hg:HgTool: pytz
    Installing custom SQL ...
    Installing indexes ...
    No fixtures found.

    注意，以上不是说reviewboard.scmtools.svn:SVNTool不能装载，而是pytz。
    解决方案：安装pytz。
    引申一下，依赖的部分可以在
    /home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/setup.py下找到。
        install_requires=[
            'Django>=1.2.4',
            'django_evolution>=0.6.2',
            'Djblets>=0.6.7',
            'Pygments>=1.3.1',
            'flup',
            'paramiko',
            'python-dateutil',
            'python-memcached',
            'pytz',
            'recaptcha_client',
        ],

    
    安装Pygments： Python Syntax Highlighting
    方法一：
    easy_install Pygments
    方法二：
    http://pypi.python.org/pypi/Pygments
    wget "http://pypi.python.org/packages/source/P/Pygments/Pygments-1.4.tar.gz#md5=d77ac8c93a7fb27545f2522abe9cc462"
    tar zxvf Pygments-1.4.tar.gz
    cd Pygments-1.4
    python setup.py install


    安装flup：random Python WSGI stuff
        WSGI：Python Web Server Gateway Interface
    http://trac.saddi.com/flup
    wget "http://www.saddi.com/software/flup/dist/flup-1.0.2.tar.gz"
    tar zxvf flup-1.0.2.tar.gz
    cd flup-1.0.2
    python setup.py install


    安装paramiko： ssh2 protocol for python
        依赖：pycrypto-2.3.tar.gz
        URL：http://www.pycrypto.org/files/pycrypto-2.3.tar.gz
    http://pypi.python.org/pypi/paramiko
    wget "http://pypi.python.org/packages/source/p/paramiko/paramiko-1.7.6.zip#md5=b1cfe0cd55772115f808a11c1baba8a0"
    unzip paramiko-1.7.6.zip
    cd paramiko-1.7.6
    python setup.py install
    设置http_proxy以后，可以自动下载依赖。


    安装python-dateutil
    http://niemeyer.net/python-dateutil
    wget "http://niemeyer.net/download/python-dateutil/python-dateutil-1.5.tar.gz"
    tar zxvf python-dateutil-1.5.tar.gz
    cd python-dateutil-1.5
    python setup.py install

    
    安装python-memcached
    http://pypi.python.org/pypi/python-memcached/
    wget "ftp://ftp.tummy.com/pub/python-memcached/old-releases/python-memcached-1.47.tar.gz"
    tar zxvf python-memcached-1.47.tar.gz
    cd python-memcached-1.47
    python setup.py install


    安装pytz： Python Time Zone
    http://pypi.python.org/pypi/pytz/2011e#downloads
    wget "http://pypi.python.org/packages/source/p/pytz/pytz-2011e.tar.bz2#md5=c853b779a71f86e16755395f78958ab6"
    tar jxvf pytz-2011e.tar.bz2
    cd pytz-2011e
    python setup.py install

    #### pytz需要连接网络
    完毕。


mysql -u root
> drop database reviewboard;
> create database reviewboard;

python manage.py test
python manage.py syncdb

    [work@tc-news-lvi0.tc.baidu.com reviewboard]$ python manage.py syncdb
    Creating tables ...
    Creating table django_admin_log
    Creating table auth_permission
    Creating table auth_group_permissions
    Creating table auth_group
    Creating table auth_user_user_permissions
    Creating table auth_user_groups
    Creating table auth_user
    Creating table auth_message
    Creating table django_content_type
    Creating table django_site
    Creating table django_session
    Creating table siteconfig_siteconfiguration
    Creating table accounts_reviewrequestvisit
    Creating table accounts_profile_starred_review_requests
    Creating table accounts_profile_starred_groups
    Creating table accounts_profile
    Creating table accounts_localsiteprofile
    Creating table changedescs_changedescription
    Creating table diffviewer_filediff
    Creating table diffviewer_diffset
    Creating table diffviewer_diffsethistory
    Creating table reviews_group_users
    Creating table reviews_group
    Creating table reviews_defaultreviewer_repository
    Creating table reviews_defaultreviewer_people
    Creating table reviews_defaultreviewer_groups
    Creating table reviews_defaultreviewer
    Creating table reviews_screenshot
    Creating table reviews_reviewrequest_changedescs
    Creating table reviews_reviewrequest_target_people
    Creating table reviews_reviewrequest_inactive_screenshots
    Creating table reviews_reviewrequest_screenshots
    Creating table reviews_reviewrequest_target_groups
    Creating table reviews_reviewrequest
    Creating table reviews_reviewrequestdraft_target_people
    Creating table reviews_reviewrequestdraft_inactive_screenshots
    Creating table reviews_reviewrequestdraft_screenshots
    Creating table reviews_reviewrequestdraft_target_groups
    Creating table reviews_reviewrequestdraft
    Creating table reviews_comment
    Creating table reviews_screenshotcomment
    Creating table reviews_review_comments
    Creating table reviews_review_screenshot_comments
    Creating table reviews_review
    Creating table scmtools_tool
    Creating table scmtools_repository_review_groups
    Creating table scmtools_repository_users
    Creating table scmtools_repository
    Creating table site_localsite_users
    Creating table site_localsite_admins
    Creating table site_localsite
    Creating table django_project_version
    Creating table django_evolution
    /home/work/softwares/python/lib/python2.5/site-packages/pycrypto-2.3-py2.5-linux-x86_64.egg/Crypto/Util/randpool.py:40: RandomPool_DeprecationWarning: This application uses RandomPool, which is BROKEN in older releases.  See http://www.pycrypto.org/randpool-broken
      RandomPool_DeprecationWarning)
    Registering new SCM Tool Subversion (reviewboard.scmtools.svn.SVNTool) in database
    Registering new SCM Tool Git (reviewboard.scmtools.git.GitTool) in database
    Registering new SCM Tool Bazaar (reviewboard.scmtools.bzr.BZRTool) in database
    Registering new SCM Tool CVS (reviewboard.scmtools.cvs.CVSTool) in database
    Registering new SCM Tool Perforce (reviewboard.scmtools.perforce.PerforceTool) in database
    Registering new SCM Tool Plastic SCM (reviewboard.scmtools.plastic.PlasticTool) in database
    Registering new SCM Tool Clear Case (reviewboard.scmtools.clearcase.ClearCaseTool) in database
    Registering new SCM Tool Mercurial (reviewboard.scmtools.hg.HgTool) in database
    Installing baseline version
    Evolutions in sessions baseline: session_expire_date_db_index
    Evolutions in diffviewer baseline: add_parent_diffs, filediff_filenames_1024_chars, diffset_basedir, filediff_status
    Evolutions in reviews baseline: change_descriptions, last_review_timestamp, shipit_count, default_reviewer_repositories, null_repository, localsite, group_incoming_request_count, group_invite_only, group_visible, default_reviewer_local_site
    Evolutions in scmtools baseline: bugzilla_url_charfield, repository_raw_file_url, repository_visible, repository_path_length_255, localsite, repository_access_control, group_site

    You just installed Django's auth system, which means you don't have any superusers defined.
    Would you like to create one now? (yes/no):yes
    Username (Leave blank to use 'work'): 
    E-mail address: hudamin@baidu.com
    Password: reviewboard
    Password (again): reviewboard
    Superuser created successfully.
    Installing custom SQL ...
    Installing indexes ...
    No fixtures found.

完成syncdb。

mkdir -p /home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard/reviewboard/htdocs/media/upload/images
cp -rf /home/work/repos_softwares/review-board/Djblets/Djblets-0.6.7/djblets/media \
    /home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard/reviewboard/htdocs/media/djblets

python manage.py runserver tc-news-lvi0.tc:8030
    ...
    TypeError: serve() got an unexpected keyword argument insecure
    ...

    解决方案：
    修改urls.py，注释掉insecure那个分支。


命令行启动方式：

export http_proxy=http://tc-apptest-img06.vm.baidu.com:8066
export DJANGO_SETTINGS_MODULE=reviewboard.settings
export PYTHONPATH=/home/work/softwares/python/lib/python2.5/site-packages/setuptools-0.6c11-py2.5.egg\
:/home/work/softwares/python/lib/python2.5/site-packages/MySQL_python-1.2.3-py2.5-linux-x86_64.egg\
:/home/work/softwares/python/lib/python2.5/site-packages/pysvn-1.7.5-py2.5-linux-x86_64.egg\
:/home/work/softwares/python/lib/python2.5/site-packages/nose-1.0.0-py2.5.egg\
:/home/work/softwares/python/lib/python25.zip\
:/home/work/softwares/python/lib/python2.5\
:/home/work/softwares/python/lib/python2.5/plat-linux2\
:/home/work/softwares/python/lib/python2.5/lib-tk\
:/home/work/softwares/python/lib/python2.5/lib-dynload\
:/home/work/softwares/python/lib/python2.5/site-packages\
:/home/work/repos_softwares/review-board/ReviewBoard-1.6beta1\
:/home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard

python manage.py runserver tc-news-lvi0.tc:8030


    Add repository 提交时提示错误，问题还是找过来了【出来混，迟早得还的】。
    Please correct the error below.
    libcom_err.so.3: cannot open shared object file: No such file or directory
    问题解析：
    $ cd /home/work/softwares/python/lib/python2.5/site-packages/pysvn-1.7.5-py2.5-linux-x86_64.egg/pysvn
    $ ldd _pysvn_2_5.so
    ...
    libcom_err.so.3 => not found
    libresolv.so.2 => /lib64/libresolv.so.2 (0x0000002a95be6000)
    libexpat.so.1 => not found
    ...
    这两个的动态库文件都没有找到。
    解决方案：
    用root权限，往/usr/lib64目录下cp对应未找到的so文件，并添加符号链接。

    
    重试，又有问题：
    pysvn was built against newer (svn, apr, etc.) libraries then the ones installed on this system. /home/work/svn/subversion-1.6.11/lib/libssl.so.0.9.7: undefined symbol: HMAC_CTX_set_flags
    问题：
    libssl库太旧


问题：
1. 匿名用户访问错误。
2. IE浏览器访问，js脚本报错：datastore.js
3. 上传diff文件错误：
    2011-04-10 23:10:29,314 - ERROR - Error uploading new diff: global name 'ClientError' is not defined
    Traceback (most recent call last):
      File "/home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard/webapi/resources.py", line 1209, in create
        request.FILES.get('parent_diff_path'))
      File "/home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard/reviews/forms.py", line 284, in create
        history)
      File "/home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard/diffviewer/forms.py", line 63, in create
        diff_file, basedir, check_existance=(not parent_diff_file)))
      File "/home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard/diffviewer/forms.py", line 149, in _process_files
        not tool.file_exists(filename, revision))):
      File "/home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard/scmtools/core.py", line 68, in file_exists
        self.get_file(path, revision)
      File "/home/work/repos_softwares/review-board/ReviewBoard-1.6beta1/reviewboard/scmtools/svn.py", line 133, in get_file
        except ClientError, e:
    NameError: global name 'ClientError' is not defined

    无缘无故好了，尚不知原因。




安装post-review

post-review命令行工具，提高发起review request的效率。
下载：https://github.com/reviewboard/rbtools
wget "https://download.github.com/reviewboard-rbtools-release-0.3.2-6-g885f880.tar.gz"
tar zxvf reviewboard-rbtools-release-0.3.2-6-g885f880.tar.gz
cd reviewboard-rbtools-release-0.3.2-6-g885f880
python setup.py install
    ...
    Searching for simplejson
    Reading http://downloads.reviewboard.org/releases/RBTools/0.3/
    Reading http://pypi.python.org/simple/simplejson/
    Reading http://undefined.org/python/#simplejson
    Best match: simplejson 2.1.3
    Downloading http://pypi.python.org/packages/source/s/simplejson/simplejson-2.1.3.tar.gz#md5=58d9b1d8fa17ea4ce205cea088607e02
    Processing simplejson-2.1.3.tar.gz
    Running simplejson-2.1.3/setup.py -q bdist_egg --dist-dir /tmp/easy_install-OL1N-P/simplejson-2.1.3/egg-dist-tmp-EZcchn
    simplejson/_speedups.c: In function `encoder_listencode_dict':
    simplejson/_speedups.c:2279: warning: implicit declaration of function `Py_SIZE'
    Adding simplejson 2.1.3 to easy-install.pth file

    Installed /home/work/softwares/python/lib/python2.5/site-packages/simplejson-2.1.3-py2.5-linux-x86_64.egg
    Finished processing dependencies for RBTools==0.3.2.dev

    对simplejson有依赖，会自动下载并安装。

安装好以后，python的bin目录下会多出来一个post-review可执行文件。

配置运行环境：
文档：http://www.reviewboard.org/docs/manual/dev/users/tools/post-review/
svn propset reviewboard:url http://tc-news-lvi0.tc.baidu.com:8020/reviewboard .

# review修改但尚未提交的代码：
post-review                         # 默认将当前工作集通基线版本的diff提交review
post-review -r 45                   # 更新review代号为45的diff
post-review src/foo.c data/bar.png  # 仅提交某些文件的diff

# review已经提交的代码（比如用于整个BRANCH的修改review）：
post-review --revision-range=STARTREV:STOPREV   # 将[STARTREV, STOPREV)之间的所有改动提交review
post-review --revision-range=REVISION           # 将[STARTREV, TOP)之间的所有改动提交review

# review已经存在的diff文件：
post-review --diff-filename=mycode.diff # 将当前diff文件提交review
    或者 cat mycode.diff | post-review --diff-filename=-
    



安装memcached
http://memcached.org/
wget "http://memcached.googlecode.com/files/memcached-1.4.5.tar.gz"
tar zxvf memcached-1.4.5.tar.gz
cd memcached-1.4.5
mkdir /home/work/softwares/memcached
./configure --prefix=/home/img/softwares/memcached \
    --enable-64bit
    出错：
    checking for libevent directory... configure: error: libevent is required.  
        You can get it from http://www.monkey.org/~provos/libevent/
      If it's already installed, specify its path using --with-libevent=/dir/
    需要安装libevent依赖。
    
    安装libevent
    The libevent API provides a mechanism to execute a callback function when a specific event occurs on a file descriptor or after a timeout has been reached. Furthermore, libevent also support callbacks due to signals or regular timeouts.
    URL：http://www.monkey.org/~provos/libevent/
    wget "http://www.monkey.org/~provos/libevent-2.0.10-stable.tar.gz"
    tar zxvf libevent-2.0.10-stable.tar.gz
    cd libevent-2.0.10-stable
    su root
    ./configure
    make
    make install
    完成安装libevent至/usr/lib

继续进行memcached的安装
./configure --prefix=/home/work/softwares/memcached \
    --enable-64bit
make
make install
    出错：
    [work@tc-news-lvi0.tc.baidu.com bin]$ ./memcached --help
    ./memcached: error while loading shared libraries: libevent-2.0.so.5: cannot open shared object file: No such file or directory
    解析：
    ldd memcached
    libevent-2.0.so.5 => not found
    libpthread.so.0 => /lib64/tls/libpthread.so.0 (0x0000002a9566c000)
    libc.so.6 => /lib64/tls/libc.so.6 (0x0000002a95781000)
    /lib64/ld-linux-x86-64.so.2 (0x0000002a95556000)
    解决方案：
    指定libevent目录。

./configure --prefix=/home/work/softwares/memcached \
    --with-libevent=/usr/local/lib \
    --enable-64bit
make
make install
    错误依旧

./configure --prefix=/home/work/softwares/memcached \
    LDFLAGS="-L/usr/local/lib" \
    --with-libevent=/usr/local/lib \
    --enable-64bit
make
make install
    错误依旧

终极解决方案：
    cd /lib64
    ln -s /usr/local/lib/libevent-2.0.so.5.0.1 libevent-2.0.so.5
    nnd，必须从/lib64下装载so文件。

启动memcached：
cd /home/work/softwares/memcached/bin
./memcached -m 128 -p 8211          # 前台模式
./memcached -d -m 128 -p 8211       # 后台模式

netstat -lp 

修改settings_local.py
添加
CACHE_BACKEND = 'memcached://localhost:8211'
# 注意，不能在后面添加两个斜线，否则无法解析连接串。提供的例子是包含了两个斜线的。可以无斜线或者单斜线。




MySQL命令：
mysql -u root \
    -D reviewboard \
    -e "show tables;"




Apache

添加mod_python配置
    ...
    PythonPath "sys.path + ['/home/work/softwares/reviewboard/apache/rb']"
    ...

./apachectl stop
./apachectl start

访问页面
    错误：
    ...
      File "/home/work/softwares/python/lib/python2.5/site-packages/django/db/backends/mysql/base.py", line 14, in <module>
        raise ImproperlyConfigured("Error loading MySQLdb module: %s" % e)

    ImproperlyConfigured: Error loading MySQLdb module: No module named MySQLdb

    解决方案：
        MySQLdb不在sys.path里面，可以通过在/home/work/softwares/python/lib/python2.5/site-packages/django/core/handlers/modpython.py
        添加代码行，输出sys.path内容，查看是否没有包含对应egg文件。
        修改httpd.conf的mod_python配置：
        PythonPath "sys.path + ['/home/work/softwares/reviewboard/apache/rb', '/home/work/softwares/python/lib/python2.5/site-packages/MySQL_python-1.2.3-py2.5-linux-x86_64.egg']"

./apachectl start

访问页面
错误消失

Apache配置：
<Location />
Allow from all
PythonPath "sys.path + \
['/home/work/softwares/reviewboard/apache/rb', \
'/home/work/softwares/python/lib/python2.5/site-packages/pysvn-1.7.5-py2.5-linux-x86_64.egg', \
'/home/work/softwares/python/lib/python2.5/site-packages/MySQL_python-1.2.3-py2.5-linux-x86_64.egg']"
SetEnv DJANGO_SETTINGS_MODULE reviewboard.settings
SetEnv PYTHON_EGG_CACHE "/home/work/softwares/reviewboard/apache/rb/tmp/egg_cache"
#SetEnv HOME "@sitedir@/data"
SetHandler mod_python
PythonHandler django.core.handlers.modpython
PythonAutoReload On
PythonDebug Off
</Location>

TIPS：
可以通过设置SetEnv来提供HTTP PROXY功能。
SetEnv http_proxy "http://tc-apptest-img06.vm.baidu.com:8066"



Review Board 【apache mod_python方式】：
debug模式
    使用python程序进行static文件的转发，SITE_ROOT设置成/，才能使静态文件顺利获取。
    可以直接使用
    python manage.py runserver tc-news-lvi0.tc:8030
    启动服务，且文件修改即时生效。

release模式
    使用apache处理静态文件，SITE_ROOT设置不限制为/

debug模式 -> release模式
1. 修改apache配置，将静态文件（media）和程序分开提供服务。配置两个Location，并设置对应的环境变量（参考以上相关说明）；
2. 将errordocs整合至apache的document root下；


SITE_MEDIA_ROOT可以通过管理UI设置，并且会覆盖settings[_local].py的配置。
在syncdb的时候，数据库表会记下上传screenshot的磁盘绝对路径，需要注意。




安装postfix邮件服务器：an alternative of sendmail
URL: http://www.postfix.org/
wget "http://postfix.it-austria.net/releases/official/postfix-2.8.2.tar.gz"
tar zxvf postfix-2.8.2.tar.gz
cd postfix-2.8.2
make tidy
    提示少了db.h
    需要安装Berkely DB的源文件，用于安装。
    参考：http://www.postfix.org/LINUX_README.html


    查看该下载那个版本的源文件：
    rpm -qf /lib64/libdb.so.4
    下载对应版本的devel rpm包 db4-devel-4.2.52-7.1.x86_64.rpm

题外话：
    下载rpm包的资源站：
    http://ftp2.scientificlinux.org/linux/scientific/40/x86_64/sites/example/RPMS/repodata/repoview/db4-devel-0-4.2.52-7.1.html
    
    wget "http://ftp2.scientificlinux.org/linux/scientific/40/x86_64/sites/example/RPMS/db4-devel-4.2.52-7.1.x86_64.rpm"
    su root
    rpm -ivh db4-devel-4.2.52-7.1.x86_64.rpm

继续进行postfix的安装
su root
make

/usr/sbin/groupadd -g 600 postfix
/usr/sbin/useradd -u 601 -g postfix -p postfix postfix
/usr/sbin/groupadd -g 602 postdrop


make install

    ...
    /bin/sh postfix-install

        Warning: if you use this script to install Postfix locally,
        this script will replace existing sendmail or Postfix programs.
        Make backups if you want to be able to recover.

        Before installing files, this script prompts you for some definitions.
        Most definitions will be remembered, so you have to specify them
        only once. All definitions should have a reasonable default value.

    Please specify the prefix for installed file names. Specify this ONLY
    if you are building ready-to-install packages for distribution to other
    machines.
    install_root: [/]
        
    Please specify a directory for scratch files while installing Postfix. You
    must have write permission in this directory.
    tempdir: [/home/work/repos_softwares/mail_softwares/postfix-2.8.2] /var/tmp

    Please specify the final destination directory for installed Postfix
    configuration files.
    config_directory: [/etc/postfix]

    Please specify the final destination directory for installed Postfix
    administrative commands. This directory should be in the command search
    path of adminstrative users.
    command_directory: [/usr/sbin]

    Please specify the final destination directory for installed Postfix
    daemon programs. This directory should not be in the command search path
    of any users.
    daemon_directory: [/usr/libexec/postfix]

    Please specify the final destination directory for Postfix-writable
    data files such as caches or random numbers. This directory should not
    be shared with non-Postfix software.
    data_directory: [/var/lib/postfix]

    Please specify the destination directory for the Postfix HTML
    files. Specify "no" if you do not want to install these files.
    html_directory: [no] no

    Please specify the owner of the Postfix queue. Specify an account with
    numerical user ID and group ID values that are not used by any other
    accounts on the system.
    mail_owner: [postfix]

    Please specify the final destination pathname for the installed Postfix
    mailq command. This is the Sendmail-compatible mail queue listing command.
    mailq_path: [/usr/bin/mailq]

    Please specify the destination directory for the Postfix on-line manual
    pages. You can no longer specify "no" here.
    manpage_directory: [/usr/local/man]

    Please specify the final destination pathname for the installed Postfix
    newaliases command. This is the Sendmail-compatible command to build
    alias databases for the Postfix local delivery agent.
    newaliases_path: [/usr/bin/newaliases]

    Please specify the final destination directory for Postfix queues.
    queue_directory: [/var/spool/postfix] 

    Please specify the destination directory for the Postfix README
    files. Specify "no" if you do not want to install these files.
    readme_directory: [no] 

    Please specify the final destination pathname for the installed Postfix
    sendmail command. This is the Sendmail-compatible mail posting interface.
    sendmail_path: [/usr/sbin/sendmail]

    Please specify the group for mail submission and for queue management
    commands. Specify a group name with a numerical group ID that is
    not shared with other accounts, not even with the Postfix mail_owner
    account. You can no longer specify "no" here.
    setgid_group: [postdrop] 

    setgid_group: [postdrop] 
    Updating /usr/libexec/postfix/anvil...
    Updating /usr/libexec/postfix/bounce...
    Updating /usr/libexec/postfix/cleanup...
    Updating /usr/libexec/postfix/discard...
    Updating /usr/libexec/postfix/dnsblog...
    Updating /usr/libexec/postfix/error...
    Updating /usr/libexec/postfix/flush...
    Updating /usr/libexec/postfix/local...
    Updating /usr/libexec/postfix/main.cf...
    Updating /usr/libexec/postfix/master.cf...
    Updating /usr/libexec/postfix/master...
    Updating /usr/libexec/postfix/oqmgr...
    Updating /usr/libexec/postfix/pickup...
    Updating /usr/libexec/postfix/pipe...
    Updating /usr/libexec/postfix/post-install...
    Updating /usr/libexec/postfix/postfix-files...
    Updating /usr/libexec/postfix/postfix-script...
    Updating /usr/libexec/postfix/postfix-wrapper...
    Updating /usr/libexec/postfix/postmulti-script...
    Updating /usr/libexec/postfix/postscreen...
    Updating /usr/libexec/postfix/proxymap...
    Updating /usr/libexec/postfix/qmgr...
    Updating /usr/libexec/postfix/qmqpd...
    Updating /usr/libexec/postfix/scache...
    Updating /usr/libexec/postfix/showq...
    Updating /usr/libexec/postfix/smtp...
    Updating /usr/libexec/postfix/smtpd...
    Updating /usr/libexec/postfix/spawn...
    Updating /usr/libexec/postfix/tlsproxy...
    Updating /usr/libexec/postfix/tlsmgr...
    Updating /usr/libexec/postfix/trivial-rewrite...
    Updating /usr/libexec/postfix/verify...
    Updating /usr/libexec/postfix/virtual...
    Updating /usr/libexec/postfix/nqmgr...
    Updating /usr/libexec/postfix/lmtp...
    Updating /usr/sbin/postalias...
    Updating /usr/sbin/postcat...
    Updating /usr/sbin/postconf...
    Updating /usr/sbin/postfix...
    Updating /usr/sbin/postkick...
    Updating /usr/sbin/postlock...
    Updating /usr/sbin/postlog...
    Updating /usr/sbin/postmap...
    Updating /usr/sbin/postmulti...
    Updating /usr/sbin/postsuper...
    Updating /usr/sbin/postdrop...
    Updating /usr/sbin/postqueue...
    Updating /usr/sbin/sendmail...
    Skipping /usr/bin/newaliases...
    Skipping /usr/bin/mailq...
    Updating /etc/postfix/LICENSE...
    Updating /etc/postfix/TLS_LICENSE...
    Updating /etc/postfix/access...
    Updating /etc/postfix/aliases...
    Updating /etc/postfix/bounce.cf.default...
    Updating /etc/postfix/canonical...
    Updating /etc/postfix/generic...
    Updating /etc/postfix/header_checks...
    Updating /etc/postfix/main.cf.default...
    Updating /etc/postfix/main.cf...
    Updating /etc/postfix/makedefs.out...
    Updating /etc/postfix/master.cf...
    Updating /etc/postfix/relocated...
    Updating /etc/postfix/transport...
    Updating /etc/postfix/virtual...
    Updating /usr/local/man/man1/mailq.1...
    Updating /usr/local/man/man1/newaliases.1...
    Updating /usr/local/man/man1/postalias.1...
    Updating /usr/local/man/man1/postcat.1...
    Updating /usr/local/man/man1/postconf.1...
    Updating /usr/local/man/man1/postdrop.1...
    Updating /usr/local/man/man1/postfix.1...
    Updating /usr/local/man/man1/postkick.1...
    Updating /usr/local/man/man1/postlock.1...
    Updating /usr/local/man/man1/postlog.1...
    Updating /usr/local/man/man1/postmap.1...
    Updating /usr/local/man/man1/postmulti.1...
    Updating /usr/local/man/man1/postqueue.1...
    Updating /usr/local/man/man1/postsuper.1...
    Updating /usr/local/man/man1/sendmail.1...
    Updating /usr/local/man/man5/access.5...
    Updating /usr/local/man/man5/aliases.5...
    Updating /usr/local/man/man5/body_checks.5...
    Updating /usr/local/man/man5/bounce.5...
    Updating /usr/local/man/man5/canonical.5...
    Updating /usr/local/man/man5/cidr_table.5...
    Updating /usr/local/man/man5/generic.5...
    Updating /usr/local/man/man5/header_checks.5...
    Updating /usr/local/man/man5/ldap_table.5...
    Updating /usr/local/man/man5/master.5...
    Updating /usr/local/man/man5/mysql_table.5...
    Updating /usr/local/man/man5/sqlite_table.5...
    Updating /usr/local/man/man5/nisplus_table.5...
    Updating /usr/local/man/man5/pcre_table.5...
    Updating /usr/local/man/man5/pgsql_table.5...
    Updating /usr/local/man/man5/postconf.5...
    Updating /usr/local/man/man5/postfix-wrapper.5...
    Updating /usr/local/man/man5/regexp_table.5...
    Updating /usr/local/man/man5/relocated.5...
    Updating /usr/local/man/man5/tcp_table.5...
    Updating /usr/local/man/man5/transport.5...
    Updating /usr/local/man/man5/virtual.5...
    Updating /usr/local/man/man8/bounce.8...
    Updating /usr/local/man/man8/cleanup.8...
    Updating /usr/local/man/man8/anvil.8...
    Updating /usr/local/man/man8/defer.8...
    Updating /usr/local/man/man8/discard.8...
    Updating /usr/local/man/man8/dnsblog.8...
    Updating /usr/local/man/man8/error.8...
    Updating /usr/local/man/man8/flush.8...
    Updating /usr/local/man/man8/lmtp.8...
    Updating /usr/local/man/man8/local.8...
    Updating /usr/local/man/man8/master.8...
    Updating /usr/local/man/man8/oqmgr.8...
    Updating /usr/local/man/man8/pickup.8...
    Updating /usr/local/man/man8/pipe.8...
    Updating /usr/local/man/man8/postscreen.8...
    Updating /usr/local/man/man8/proxymap.8...
    Updating /usr/local/man/man8/qmgr.8...
    Updating /usr/local/man/man8/qmqpd.8...
    Updating /usr/local/man/man8/scache.8...
    Updating /usr/local/man/man8/showq.8...
    Updating /usr/local/man/man8/smtp.8...
    Updating /usr/local/man/man8/smtpd.8...
    Updating /usr/local/man/man8/spawn.8...
    Updating /usr/local/man/man8/tlsproxy.8...
    Updating /usr/local/man/man8/tlsmgr.8...
    Updating /usr/local/man/man8/trace.8...
    Updating /usr/local/man/man8/trivial-rewrite.8...
    Updating /usr/local/man/man8/verify.8...
    Updating /usr/local/man/man8/virtual.8...

        Warning: you still need to edit myorigin/mydestination/mynetworks
        parameter settings in /etc/postfix/main.cf.

        See also http://www.postfix.org/STANDARD_CONFIGURATION_README.html
        for information about dialup sites or about sites inside a firewalled
        network.

        BTW: Check your /etc/aliases file and be sure to set up aliases
        that send mail for root and postmaster to a real person, then run
        /usr/bin/newaliases.


安装完成。

配置需要启动哪些服务：
vim /etc/postfix/master.cf
不需要的服务注释掉即可。

悲剧，把sendmail给覆盖了，不过也无所谓。
实际上sendmail都没有放到常用命令PATH，需要直接全路径调用：
/usr/sbin/sendmail
就因为这，让人误认为没有sendmail，所以才将postfix的sendmail安装在/usr/sbin/sendmail，造成了覆盖。

启动postfix，需要root权限：
su root
/usr/sbin/postfix start


百度内网smtp服务器[通过tcpdump得到的地址]：
mail1-in.baidu.com 25
mail2-in.baidu.com 25

tcpdump只能root权限使用




总结一下：

python安装
python的第三方程序库的安装，包括
    MySQL-python-1.2.3  




1.6rc1版本：
Djblets需要0.6.8（包含）以上版本
django-evolution>=0.6.4


## 关于升级
1. 通常会有数据库结构的升级，新版本的代码如果使用老的数据库，一般都会出错，导致无法使用。可以使用rbsite工具做一次升级。
    python rbsite.py update path # rbsite.py在cmdline目录下
如果有问题的话，可以使用手工的方式，重新同步一下数据库即可。这个比较靠谱：
    python reviewboard/manage.py syncdb


