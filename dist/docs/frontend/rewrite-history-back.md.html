<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/bootstrap/css/bootstrap-theme.min.css" />
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/css/github-markdown.css" />
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/css/page.css" />
    <script type="text/javascript" src="/docs/markdown_res/js/jquery-1.9.1.min.js"></script>
    <style type="text/css">

    </style>

</head>
<body class="markdown-body">
    <div id="nav" class="row">
<a class="text-info pull-right" href="javascript:history.back()">Back</a>
    </div>

<h1> Rewrite history.back</h1>
<blockquote><p> 注意重写history对象是不行的，只能重写history.back</p></blockquote>


<h2> 一、注意点</h2>
<p><code>history.length</code>表示浏览过的历史数目。</p>
<p><code>不能</code>判断还能不能后退，或者当前在历史中的索引。</p>
<p>需要使用一些hack方法，比如使用<code>延时</code>和注册<code>onbeforeunload和onhashchange事件</code>，如第二种方法。</p>




<h2> 二、方案</h2>
<ol><li>一棍子打死，直接重写：<pre><code>(function(){

    if(window.oldHistoryBack) return;

    var oldBack = window.oldHistoryBack = history.back;
    history.back = function(){
        location.href= 'bdapi://hybrid?info={"action": "history_back", "args": {}}'; 
        console.log('trigger events');
    }

})(); 
history.back();  </code></pre>
</li>
<li>稍作判断，在后退到第一个历史的时候触发：<pre><code>(function(){

    if(window.oldHistoryBack) return;

    var oldBack = window.oldHistoryBack = history.back;
    history.back = function(){
        var timer = setTimeout(function(){
            location.href= 'bdapi://hybrid?info={"action": "history_back", "args": {}}'; 
            console.log('trigger events');
        }, 100);

        window.onbeforeunload = function(e){
            clearTimeout(timer);
        };

        window.onhashchange = function(e){
            clearTimeout(timer);
        };

        oldBack.apply(history, arguments);
    }

})(); 
history.back();   </code></pre>
</li></ol>

</body>
</html>
<script type="text/javascript" src="/docs/markdown_res/js/footer.js"></script>
<script type="text/javascript" src="/docs/markdown_res/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/docs/markdown_res/js/scrollspy.js"></script>
