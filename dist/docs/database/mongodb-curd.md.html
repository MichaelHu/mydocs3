<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/bootstrap/css/bootstrap-theme.min.css" />
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/css/github-markdown.css" />
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/css/page.css" />
    <script type="text/javascript" src="/docs/markdown_res/js/jquery-1.9.1.min.js"></script>
    <style type="text/css">

    </style>

</head>
<body class="markdown-body">
    <div id="nav" class="row">
<a class="text-info pull-right" href="javascript:history.back()">Back</a>
    </div>

<h1> MongoDB CURDs</h1>

<blockquote><p> <code>collection</code>的CRUD操作</p></blockquote>
<h2> 1 find</h2>


<h3> 1.1 查询条件设置</h3>
<p>每一次查询对应一个<code>Collection</code>，<code>find</code>命令通过JSON格式提供查询标准或条件</p>
<pre><code>db.users.find( { age: { $gt: 18 } } ).sort( { age: 1 } ); </code></pre>
<img src="./img/crud-query-stages.png">

<p>查找所有匹配： </p>
<pre><code>db.docs.find({})
db.docs.find()
db.docs.find().limit(5) </code></pre>
<p>条件：等于</p>
<pre><code>db.inventory.find( { type: "snacks" } )  </code></pre>
<p>使用查询操作符：</p>
<pre><code>db.inventory.find( { type: { $in: [ 'food', 'snacks' ] } } )  </code></pre>
<p>条件与：</p>
<pre><code>db.inventory.find( { type: 'food', price: { $lt: 9.95 } } )  </code></pre>
<p>条件或：</p>
<pre><code>db.inventory.find(
    {
        $or: [ { qty: { $gt: 100 } }, { price: { $lt: 9.95 } } ]
    }
)  </code></pre>
<p>条件与或：</p>
<pre><code>db.inventory.find(
    {
        type: 'food',
        $or: [ { qty: { $gt: 100 } }, { price: { $lt: 9.95 } } ]
    }
)   </code></pre>
<p>内嵌字段： </p>
<pre><code>db.inventory.find(
    {
        producer: {
            company: 'ABC123',
            address: '123 Street'
        }
    }
) </code></pre>
<p>或者：</p>
<pre><code>db.inventory.find( { 'producer.company': 'ABC123' } )  </code></pre>
<p>数组字段查询：</p>
<pre><code>// ratings数组字段的内容为[ 5, 8, 9 ]
db.inventory.find( { ratings: [ 5, 8, 9 ] } )

// ratings数组字段包含5
db.inventory.find( { ratings: 5 } )

// 数组第一个字段为5
db.inventory.find( { 'ratings.0': 5 } )     </code></pre>
<h3> 1.2 指定返回的数据字段</h3>
<p><code>_id</code>字段不显式关闭的话，总会作为一个字段返回。</p>
<pre><code>// 返回_id, item, qty字段
db.inventory.find( { type: 'food' }, { item: 1, qty: 1 } )

// 返回item, qty字段 
db.inventory.find( { type: 'food' }, { item: 1, qty: 1, _id:0 } )

// 返回嵌套字段
db.inventory.find(
   { type: 'food', _id: 3 },
   { "classification.category": 1, _id: 0 }
)

// 返回数组字段的前两个元素
db.inventory.find( { _id: 5 }, { ratings: { $slice: 2 } } )  </code></pre>
<h3> 1.3 数据集索引（Cursor）</h3>
<p>手动迭代：</p>
<pre><code>var myCursor = db.inventory.find( { type: 'food' } );

while (myCursor.hasNext()) {
    print(tojson(myCursor.next()));
} </code></pre>
<p>或</p>
<pre><code>myCursor.forEach(printjson);  </code></pre>
<p>数组下标，使用myCursor.toArray()：</p>
<pre><code>var docs = myCursor.toArray();
var myDoc = docs[2]; </code></pre>
<p>或者：</p>
<pre><code>var myDoc = myCursor[2];            </code></pre>
<h2> insert </h2>
<p>向<code>inventory</code>集合中插入一个文档。如果<code>inventory</code>不存在，则会自动创建。</p>
<pre><code>db.inventory.insert(
    {
        item: "ABC1",
        details: {
            model: "14Q3",
            manufacturer: "XYZ Company"
        },
        stock: [ { size: "S", qty: 25 }, { size: "M", qty: 50 } ],
        category: "clothing"
    }
)

返回值：

WriteResult({ "nInserted" : 1 })    </code></pre>
<p>插入文档数组：</p>
<pre><code>var mydocuments =
    [
      {
        item: "ABC2",
        details: { model: "14Q3", manufacturer: "M1 Corporation" },
        stock: [ { size: "M", qty: 50 } ],
        category: "clothing"
      },
      {
        item: "MNO2",
        details: { model: "14Q3", manufacturer: "ABC Company" },
        stock: [ { size: "S", qty: 5 }, { size: "M", qty: 5 }, { size: "L", qty: 1 } ],
        category: "clothing"
      },
      {
        item: "IJK2",
        details: { model: "14Q2", manufacturer: "M5 Corporation" },
        stock: [ { size: "S", qty: 5 }, { size: "L", qty: 1 } ],
        category: "houseware"
      }
    ];    

db.inventory.insert( mydocuments );

返回值(BulkWriteResult)：

BulkWriteResult({
   "writeErrors" : [ ],
   "writeConcernErrors" : [ ],
   "nInserted" : 3,
   "nUpserted" : 0,
   "nMatched" : 0,
   "nModified" : 0,
   "nRemoved" : 0,
   "upserted" : [ ]
})   </code></pre>
<p>打包插入多个文档，使用<code>Bulk API</code>：</p>
<pre><code>var bulk = db.inventory.initializeUnorderedBulkOp();

bulk.insert(
   {
     item: "BE10",
     details: { model: "14Q2", manufacturer: "XYZ Company" },
     stock: [ { size: "L", qty: 5 } ],
     category: "clothing"
   }
);
bulk.insert(
   {
     item: "ZYT1",
     details: { model: "14Q1", manufacturer: "ABC Company"  },
     stock: [ { size: "S", qty: 5 }, { size: "M", qty: 5 } ],
     category: "houseware"
   }
);

bulk.execute();

返回值：

BulkWriteResult({
   "writeErrors" : [ ],
   "writeConcernErrors" : [ ],
   "nInserted" : 2,
   "nUpserted" : 0,
   "nMatched" : 0,
   "nModified" : 0,
   "nRemoved" : 0,
   "upserted" : [ ]
})      </code></pre>
<h2> update</h2>
<p>更新第一个item字段为MNO2的匹配文档：</p>
<pre><code>db.inventory.update(
    { item: "MNO2" },
    {
      $set: {
        category: "apparel",
        details: { model: "14Q3", manufacturer: "XYZ Company" }
      },
      $currentDate: { lastModified: true }
    }
) </code></pre>
<p>内嵌字段，使用"<code>.</code>"分隔：</p>
<pre><code>db.inventory.update(
    { item: "ABC1" },
    { $set: { "details.model": "14Q2" } }
)  </code></pre>
<p>更新多个匹配文档</p>
<pre><code>db.inventory.update(
    { category: "clothing" },
    {
        $set: { category: "apparel" },
        $currentDate: { lastModified: true }
    },
    { multi: true }
)    </code></pre>
<h2> remove</h2>

<p>删除所有：</p>
<pre><code>db.docs.remove({})
WriteResult({ "nRemoved" : 12539 }) </code></pre>
<p>注意，不同于find方法，<code>db.docs.remove()</code>必须带参数。</p>

<p>删除指定条件的所有文档：</p>
<pre><code>db.inventory.remove( { type : "food" } )  </code></pre>
<p>删除指定条件的一个文档：</p>
<pre><code>db.inventory.remove( { type : "food" }, 1 )             </code></pre>

</body>
</html>
<script type="text/javascript" src="/docs/markdown_res/js/footer.js"></script>
<script type="text/javascript" src="/docs/markdown_res/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/docs/markdown_res/js/scrollspy.js"></script>
