<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/bootstrap/css/bootstrap-theme.min.css" />
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/css/github-markdown.css" />
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="/docs/markdown_res/css/page.css" />
    <script type="text/javascript" src="/docs/markdown_res/js/jquery-1.9.1.min.js"></script>
    <style type="text/css">

    </style>

</head>
<body class="markdown-body">
    <div id="nav" class="row">
<a class="text-info pull-right" href="javascript:history.back()">Back</a>
    </div>

<h1> MongoDB Operators </h1>
<blockquote><p> 包含查询操作符与映射操作符</p></blockquote>
<h2> 1 Query</h2>
<p>Query operators provide ways to locate data within the database and projection operators modify how data is presented.</p>

<h3> 1.1 比较类型（Comparation）：</h3>
<pre><code>Name    Description
$eq     Matches values that are equal to a specified value.
$gt     Matches values that are greater than a specified value.
$gte    Matches values that are greater than or equal to a specified value.
$lt     Matches values that are less than a specified value.
$lte    Matches values that are less than or equal to a specified value.
$ne     Matches all values that are not equal to a specified value.
$in     Matches any of the values specified in an array.
$nin    Matches none of the values specified in an array.  </code></pre>
<h3> 1.2 逻辑操作类型（Logical）：</h3>
<pre><code>$or Joins query clauses with a logical OR returns all documents that match the conditions of either clause.
$and    Joins query clauses with a logical AND returns all documents that match the conditions of both clauses.
$not    Inverts the effect of a query expression and returns documents that do not match the query expression.
$nor    Joins query clauses with a logical NOR returns all documents that fail to match both clauses.  </code></pre>
<h3> 1.3 元素相关（Element）：</h3>

<pre><code>$exists Matches documents that have the specified field.
$type   Selects documents if a field is of the specified type.   </code></pre>
<h3> 1.4 计算类型（Evaluation）：</h3>
<pre><code>$mod    Performs a modulo operation on the value of a field and selects documents with a specified result.
$regex  Selects documents where values match a specified regular expression.
$text   Performs text search.
$where  Matches documents that satisfy a JavaScript expression.  </code></pre>
<p>还有数组类型，注释类型等。</p>



<h2> 2 Projection </h2>




<h2> 3 Aggregation Pipeline Operators</h2>
<pre><code>db.collection.aggregate( [ { &lt;stage> }, ... ] ) </code></pre>
<p>多个管道操作，通过数组结构组合。</p>
<h3> 3.1 $group</h3>
<pre><code>{ $group: { _id: &lt;expression>, &lt;field1>: { &lt;accumulator1> : &lt;expression1> }, ... } } </code></pre>
<ol><li><code>_id</code>是必须提供的字段，包含唯一字段列表，也可以是<code>null</code>，比如用于计算总数时</li>
<li>其他字段使用累加操作符来计算</li></ol>
<p>累加操作符：</p>
<pre><code>$sum
$avg
$first
$last
$max
$min
$push
$addToSet  </code></pre>
<p>例子1，按日期组合，获取每日相关计算字段：</p>
<pre><code>db.sales.aggregate(
   [
      {
        $group : {
           _id : { 
                month: { $month: "$date" }
                , day: { $dayOfMonth: "$date" }
                , year: { $year: "$date" } 
           }
           , totalPrice: { $sum: { $multiply: [ "$price", "$quantity" ] } }
           , averageQuantity: { $avg: "$quantity" }
           count: { $sum: 1 }
        }
      }
   ]
)  </code></pre>
<p>返回：</p>
<pre><code>{ "_id" : { "month" : 3, "day" : 15, "year" : 2014 }, "totalPrice" : 50, "averageQuantity" : 10, "count" : 1 }
{ "_id" : { "month" : 4, "day" : 4, "year" : 2014 }, "totalPrice" : 200, "averageQuantity" : 15, "count" : 2 }
{ "_id" : { "month" : 3, "day" : 1, "year" : 2014 }, "totalPrice" : 40, "averageQuantity" : 1.5, "count" : 2 }  </code></pre>
<p>例子2，_id设置为null（不需要），计算累加字段：</p>
<pre><code>db.sales.aggregate(
   [
      {
        $group : {
           _id : null 
           , totalPrice: { $sum: { $multiply: [ "$price", "$quantity" ] } }
           , averageQuantity: { $avg: "$quantity" }
           count: { $sum: 1 }
        }
      }
   ]
) </code></pre>
<p>返回：</p>
<pre><code>{ "_id" : null, "totalPrice" : 290, "averageQuantity" : 8.6, "count" : 5 }   </code></pre>
<p>例子3，使用_id字段，获取唯一性字段：</p>
<pre><code>db.sales.aggregate( [ { $group : { _id : "$item" } } ] ) </code></pre>
<p>返回：</p>
<pre><code>{ "_id" : "xyz" }
{ "_id" : "jkl" }
{ "_id" : "abc" }   </code></pre>
<p>例子4，按作者来组合书名：</p>
<pre><code>db.books.aggregate(
   [
     { $group : { _id : "$author", books: { $push: "$title" } } }
   ]
) </code></pre>
<p>返回：</p>
<pre><code>{ "_id" : "Homer", "books" : [ "The Odyssey", "Iliad" ] }
{ "_id" : "Dante", "books" : [ "The Banquet", "Divine Comedy", "Eclogues" ] }      </code></pre>
<p>例子5，按作者来组合文档，使用系统变量<code>$$ROOT</code></p>
<pre><code>db.books.aggregate(
   [
     { $group : { _id : "$author", books: { $push: "$$ROOT" } } }
   ]
)  </code></pre>
<p>返回：</p>
<pre><code>{
  "_id" : "Homer",
  "books" :
     [
       { "_id" : 7000, "title" : "The Odyssey", "author" : "Homer", "copies" : 10 },
       { "_id" : 7020, "title" : "Iliad", "author" : "Homer", "copies" : 10 }
     ]
}

{
  "_id" : "Dante",
  "books" :
     [
       { "_id" : 8751, "title" : "The Banquet", "author" : "Dante", "copies" : 2 },
       { "_id" : 8752, "title" : "Divine Comedy", "author" : "Dante", "copies" : 1 },
       { "_id" : 8645, "title" : "Eclogues", "author" : "Dante", "copies" : 2 }
     ]
}                      </code></pre>

</body>
</html>
<script type="text/javascript" src="/docs/markdown_res/js/footer.js"></script>
<script type="text/javascript" src="/docs/markdown_res/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/docs/markdown_res/js/scrollspy.js"></script>
